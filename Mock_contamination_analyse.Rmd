---
title: "Mock_contaminatie_analyse_Stijn"
author: "Stijn Teunissen (24753)"
date: "`r Sys.Date()`"
output: html_document
---

```{r , eval=TRUE, echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}
# set optional parameters
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE, 
                      message = FALSE)
options(scipen = 999, digits = 3)
```

```{r setup, eval=TRUE, echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_knit$set(root.dir = "/Users/stijnteunissen/OneDrive - Wetsus/General/data/GitHub/microbialanalysis/")
```

```{r install packages, eval=TRUE, echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}
# install packages
if (!requireNamespace("phyloseq", quietly = TRUE)){BiocManager::install("phyloseq")}
if (!requireNamespace("qiime2R", quietly = TRUE)){devtools::install_github("jbisanz/qiime2R")}
if (!requireNamespace("tidyverse", quietly = TRUE)){devtools::install_github("tidyverse")}
if (!requireNamespace("magrittr", quietly = TRUE)){install.packages("magrittr")}
if (!requireNamespace("devtools", quietly = TRUE)){install.packages("devtools")}
if (!requireNamespace("here", quietly = TRUE)){install.packages("here")}
if (!requireNamespace("openxlsx", quietly = TRUE)){install.packages("openxlsx")}
if (!requireNamespace("ape", quietly = TRUE)){install.packages("ape")}
if (!requireNamespace("ggtext", quietly = TRUE)){install.packages("ggtext")}
if (!requireNamespace("cowplot", quietly = TRUE)){install.packages("cowplot")}
if (!requireNamespace("RColorBrewer", quietly = TRUE)){install.packages("RColorBrewer")}
if (!requireNamespace("microbiome", quietly = TRUE)){install.packages("microbiome")}
if (!requireNamespace("lme4", quietly = TRUE)){install.packages("lme4")}
if (!requireNamespace("lmerTest", quietly = TRUE)){install.packages("lmerTest")}
if (!requireNamespace("decontam", quietly = TRUE)){install.packages("decontam")}
if (!requireNamespace("ampvis2", quietly = TRUE)){install.packages("ampvis2")}
if (!requireNamespace("glue", quietly = TRUE)){install.packages("glue")}
if (!requireNamespace("lubridate", quietly = TRUE)){install.packages("lubridate")}
if (!requireNamespace("DECIPHER", quietly = TRUE)){install.packages("DECIPHER")}
if (!requireNamespace("ensembleTax", quietly = TRUE)){install.packages("ensembleTax")}
if (!requireNamespace("lmerTest", quietly = TRUE)){install.packages("lmerTest")}
if (!requireNamespace("scales", quietly = TRUE)){install.packages("scales")}
if (!requireNamespace("viridis", quietly = TRUE)){install.packages("viridis")}
if (!requireNamespace("ggrepel", quietly = TRUE)){install.packages("ggrepel")}
if (!requireNamespace("emmeans", quietly = TRUE)){install.packages("emmeans")}
if (!requireNamespace("ggforce", quietly = TRUE)){install.packages("ggforce")}
if (!requireNamespace("gridExtra", quietly = TRUE)){install.packages("gridExtra")}
if (!requireNamespace("patchwork", quietly = TRUE)){install.packages("patchwork")}
```

```{r library loading, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
# load required packages 
library(phyloseq)
library(qiime2R)
library(tidyverse)
library(magrittr)
library(devtools)
library(here)
library(openxlsx)
library(ape)
library(ggtext)
library(cowplot)
library(RColorBrewer)
library(microbiome)
library(lme4)
library(lmerTest)
library(decontam)
library(ampvis2)
library(glue)
library(lubridate)
library(DECIPHER)
library(ensembleTax)
library(lmerTest)
library(scales)
library(viridis)
library(ggrepel)
library(emmeans)
library(ggforce)
library(gridExtra)
library(patchwork)
```


```{r project organization, message=F, echo=F, eval=T, warning=F, include=F, cache=T}

# project name
proj = "STEU_Contamination_analyse"

# create directories
if(!dir.exists("figures")){dir.create("figures")}
if(!dir.exists("input_data")){dir.create("input_data")} 
if(!dir.exists("output_data")){dir.create("output_data")} 
if(!dir.exists("scripts")){dir.create("scripts")} 
```

```{r import data, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
# Script cleaning data
source("scripts/tax_clean_updated.R")

# Wetsus Data 

#creating phyloseq objects for BKIS_proj1_Q16705
metadata = read.delim("input_data/Wetsus_data/BKIS_proj1_Q16705/BKIS_proj1_Q16705_metadata.tsv", header=T, sep = "\t") 
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_BKIS_proj1_Q16705 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/BKIS_proj1_Q16705/BKIS_16S_515F_926R_08092023_Q16705_BKIS_table.qza",
  tree = "input_data/Wetsus_data/BKIS_proj1_Q16705/BKIS_16S_515F_926R_08092023_Q16705_BKIS_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/BKIS_proj1_Q16705/BKIS_16S_515F_926R_08092023_Q16705_BKIS_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_BKIS_proj1_Q16705)  = sample_data(metadata)

sample_data(physeq_BKIS_proj1_Q16705)$read_count=sample_sums(physeq_BKIS_proj1_Q16705)

physeq_BKIS_proj1_Q16705 = tax_clean(physeq_BKIS_proj1_Q16705)


#creating phyloseq objects for OBER_proj3_Q15250
metadata = read.delim("input_data/Wetsus_data/OBER_proj3_Q15250/OBER_proj3_Q15250_metadata.tsv", header=T, sep = "\t") 
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_OBER_proj3_Q15250 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/OBER_proj3_Q15250/OBER_16S_515F926R_Q15250_20220803_table.qza",
  tree = "input_data/Wetsus_data/OBER_proj3_Q15250/OBER_16S_515F926R_Q15250_20220803_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/OBER_proj3_Q15250/OBER_16S_515F926R_Q15250_20220803_taxonomy_NB_classifier_SILVA_132_99_16S_515F-926R_QIIME2-2019.10.qza",
  )
sample_data(physeq_OBER_proj3_Q15250)  = sample_data(metadata)

sample_data(physeq_OBER_proj3_Q15250)$read_count=sample_sums(physeq_OBER_proj3_Q15250)

physeq_OBER_proj3_Q15250 = tax_clean(physeq_OBER_proj3_Q15250)

#creating phyloseq objects for OSOJ_proj3_Q16374
metadata = read.delim("input_data/Wetsus_data/OSOJ_proj3_Q16374_16S/OSOJ_proj3_Q16374_metadata.tsv", header=T, sep = "\t") 
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_OSOJ_proj3_Q16374 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/OSOJ_proj3_Q16374_16S/OSOJ_16S_515F_926R_20230425_Q16347_table.qza",
  tree = "input_data/Wetsus_data/OSOJ_proj3_Q16374_16S/OSOJ_16S_515F_926R_20230425_Q16347_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/OSOJ_proj3_Q16374_16S/OSOJ_16S_515F_926R_20230425_Q16347_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_OSOJ_proj3_Q16374)  = sample_data(metadata)

sample_data(physeq_OSOJ_proj3_Q16374)$read_count=sample_sums(physeq_OSOJ_proj3_Q16374)

physeq_OSOJ_proj3_Q16374 = tax_clean(physeq_OSOJ_proj3_Q16374)

#creating phyloseq objects for OSOJ_proj4_Q17230
metadata = read.delim("input_data/Wetsus_data/OSOJ_proj4_Q17230/OSOJ_proj4_Q17230_metadata.tsv", header=T, sep = "\t") 
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_OSOJ_proj4_Q17230 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/OSOJ_proj4_Q17230/OSOJ_16S_515F_926R_02202024_Q17230_OSOJ_table.qza",
  tree = "input_data/Wetsus_data/OSOJ_proj4_Q17230/OSOJ_16S_515F_926R_02202024_Q17230_OSOJ_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/OSOJ_proj4_Q17230/OSOJ_16S_515F_926R_02202024_Q17230_OSOJ_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_OSOJ_proj4_Q17230)  = sample_data(metadata)

sample_data(physeq_OSOJ_proj4_Q17230)$read_count=sample_sums(physeq_OSOJ_proj4_Q17230)

physeq_OSOJ_proj4_Q17230 = tax_clean(physeq_OSOJ_proj4_Q17230)

#creating phyloseq objects for OSOJ_proj5_Q17229
metadata = read.delim("input_data/Wetsus_data/OSOJ_proj5_Q17229/OSOJ_proj5_Q17229_metadata.tsv", header=T, sep = "\t") 
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_OSOJ_proj5_Q17229 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/OSOJ_proj5_Q17229/OSOJ_16S_515F_926R_02202024_Q17229_OSOJ_table.qza",
  tree = "input_data/Wetsus_data/OSOJ_proj5_Q17229/OSOJ_16S_515F_926R_02202024_Q17229_OSOJ_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/OSOJ_proj5_Q17229/OSOJ_16S_515F_926R_02202024_Q17229_OSOJ_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_OSOJ_proj5_Q17229)  = sample_data(metadata)

sample_data(physeq_OSOJ_proj5_Q17229)$read_count=sample_sums(physeq_OSOJ_proj5_Q17229)

physeq_OSOJ_proj5_Q17229 = tax_clean(physeq_OSOJ_proj5_Q17229)

#creating phyloseq objects for SHSU_proj1_Q17228
metadata = read.delim("input_data/Wetsus_data/SHSU_proj1_Q17228/SHSU_proj1_Q17228_metadata.tsv", header=T, sep = "\t") 
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_SHSU_proj1_Q17228 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/SHSU_proj1_Q17228/SHSU_16S_515F_926R_02202024_Q17228_SHSU_table.qza",
  tree = "input_data/Wetsus_data/SHSU_proj1_Q17228/SHSU_16S_515F_926R_02202024_Q17228_SHSU_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/SHSU_proj1_Q17228/SHSU_16S_515F_926R_02202024_Q17228_SHSU_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_SHSU_proj1_Q17228)  = sample_data(metadata)

sample_data(physeq_SHSU_proj1_Q17228)$read_count=sample_sums(physeq_SHSU_proj1_Q17228)

physeq_SHSU_proj1_Q17228 = tax_clean(physeq_SHSU_proj1_Q17228)

#creating phyloseq objects for YLUO_projx_Q12374
metadata = read.delim("input_data/Wetsus_data/YLUO_projx_Q12374/YLUO_projx_Q12374_49_89_metadata.tsv", header=T, sep = "\t") 
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_YLUO_projx_Q12374 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/YLUO_projx_Q12374/YLUO_BAC_49_89_20200409_table.qza",
  tree = "input_data/Wetsus_data/YLUO_projx_Q12374/YLUO_BAC_49_89_20200409_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/YLUO_projx_Q12374//YLUO_BAC_49_89_20200409_taxonomy_NB_Silva132_99-338F-806R_classifier.qza",
  )
sample_data(physeq_YLUO_projx_Q12374)  = sample_data(metadata)

sample_data(physeq_YLUO_projx_Q12374)$read_count=sample_sums(physeq_YLUO_projx_Q12374)

physeq_YLUO_projx_Q12374 = tax_clean(physeq_YLUO_projx_Q12374)

#creating phyloseq objects for YXIN_proj1_Q16712
metadata = read.delim("input_data/Wetsus_data/YXIN_proj1_Q16712/YXIN_proj1_Q16712_metadata.tsv", header=T, sep = "\t") 
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_YXIN_proj1_Q16712 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/YXIN_proj1_Q16712/XYIN_16S_515F_926R_07092023_Q16712_XYIN_table.qza",
  tree = "input_data/Wetsus_data/YXIN_proj1_Q16712/XYIN_16S_515F_926R_07092023_Q16712_XYIN_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/YXIN_proj1_Q16712/XYIN_16S_515F_926R_07092023_Q16712_XYIN_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_YXIN_proj1_Q16712)  = sample_data(metadata)

sample_data(physeq_YXIN_proj1_Q16712)$read_count=sample_sums(physeq_YXIN_proj1_Q16712)

physeq_YXIN_proj1_Q16712 = tax_clean(physeq_YXIN_proj1_Q16712)

#creating phyloseq objects for KJOH_proj04_Q17535
metadata = read.delim("input_data/Wetsus_data/KJOH_proj04_Q17535/KJOH_proj04_Q17535_metadata.tsv", header=T, sep = "\t")
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_KJOH_proj04_Q17535 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/KJOH_proj04_Q17535/KJOH_16S_515F_926R_08052024_Q17535_full_KJOH_table.qza",
  tree = "input_data/Wetsus_data/KJOH_proj04_Q17535/KJOH_16S_515F_926R_08052024_Q17535_full_KJOH_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/KJOH_proj04_Q17535/KJOH_16S_515F_926R_08052024_Q17535_full_KJOH_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_KJOH_proj04_Q17535)  = sample_data(metadata)

sample_data(physeq_KJOH_proj04_Q17535)$read_count=sample_sums(physeq_KJOH_proj04_Q17535)

physeq_KJOH_proj04_Q17535 = tax_clean(physeq_KJOH_proj04_Q17535)

#creating phyloseq objects for KJOH_proj05_Q17536
metadata = read.delim("input_data/Wetsus_data/KJOH_proj05_Q17536/KJOH_proj05_Q17536_metadata.tsv", header=T, sep = "\t")
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_KJOH_proj05_Q17536 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/KJOH_proj05_Q17536/KJOH_16S_515F_926R_08052024_Q17536_full_KJOH_table.qza",
  tree = "input_data/Wetsus_data/KJOH_proj05_Q17536/KJOH_16S_515F_926R_08052024_Q17536_full_KJOH_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/KJOH_proj05_Q17536/KJOH_16S_515F_926R_08052024_Q17536_full_KJOH_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_KJOH_proj05_Q17536)  = sample_data(metadata)

sample_data(physeq_KJOH_proj05_Q17536)$read_count=sample_sums(physeq_KJOH_proj05_Q17536)

physeq_KJOH_proj05_Q17536 = tax_clean(physeq_KJOH_proj05_Q17536)

#creating phyloseq objects for KJOH_proj06_Q17537
metadata = read.delim("input_data/Wetsus_data/KJOH_proj06_Q17537/KJOH_proj06_Q17537_metadata.tsv", header=T, sep = "\t")
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_KJOH_proj06_Q17537 = qza_to_phyloseq(
  features = "input_data/Wetsus_data/KJOH_proj06_Q17537/KJOH_16S_515F_926R_08052024_Q17537_full_KJOH_table.qza",
  tree = "input_data/Wetsus_data/KJOH_proj06_Q17537/KJOH_16S_515F_926R_08052024_Q17537_full_KJOH_rooted-tree.qza",
  taxonomy = "input_data/Wetsus_data/KJOH_proj06_Q17537/KJOH_16S_515F_926R_08052024_Q17537_full_KJOH_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_KJOH_proj06_Q17537)  = sample_data(metadata)

sample_data(physeq_KJOH_proj06_Q17537)$read_count=sample_sums(physeq_KJOH_proj06_Q17537)

physeq_KJOH_proj06_Q17537 = tax_clean(physeq_KJOH_proj06_Q17537)

# External data
#creating phyloseq objects for PRJEB34118
metadata = read.delim("input_data/External_data/PRJEB34118/PRJEB34118_metadata.tsv", header=T, sep = "\t")
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_PRJEB34118 = qza_to_phyloseq(
  features = "input_data/External_data/PRJEB34118/PRJEB34118_table.qza",
  tree = "input_data/External_data/PRJEB34118/PRJEB34118_rooted-tree.qza",
  taxonomy = "input_data/External_data/PRJEB34118/PRJEB34118_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_PRJEB34118)  = sample_data(metadata)

sample_data(physeq_PRJEB34118)$read_count=sample_sums(physeq_PRJEB34118)

physeq_PRJEB34118 = tax_clean(physeq_PRJEB34118)

#creating phyloseq objects for PRJNA862376
metadata = read.delim("input_data/External_data/PRJNA862376//PRJNA862376_metadata.tsv", header=T, sep = "\t")
colnames(metadata)[1] =  gsub(colnames(metadata)[1], pattern = "X.", "SampleID")
metadata = sample_data(metadata)
sample_names(metadata) = metadata$SampleID

physeq_PRJNA862376 = qza_to_phyloseq(
  features = "input_data/External_data/PRJNA862376/PRJNA862376_table.qza",
  tree = "input_data/External_data/PRJNA862376/PRJNA862376_rooted-tree.qza",
  taxonomy = "input_data/External_data/PRJNA862376/PRJNA862376_silva-138-99-nb-classifier.qza",
  )
sample_data(physeq_PRJNA862376)  = sample_data(metadata)

sample_data(physeq_PRJNA862376)$read_count=sample_sums(physeq_PRJNA862376)

physeq_PRJNA862376 = tax_clean(physeq_PRJNA862376)
```

```{r bind data, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
# bind different studies

# Wetsus data

# BKIS_proj1_Q16705
BKIS_proj1_Q16705 = 
  physeq_BKIS_proj1_Q16705 %>% 
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>% 
  #prune_taxa(taxa_sums(.)>0.01, .) %>% 
  psmelt() %>% 
  as_tibble() %>% 
  mutate(study = "BKIS_proj1_Q16705")

# filter mock out and at prevalence 
physeq_BKIS_proj1_Q16705_no_mock = 
physeq_BKIS_proj1_Q16705 %>% 
  subset_samples(., Sample_mock == "sample") %>% 
  prune_taxa(taxa_sums(.)>0, .) %>% 
  microbiome::prevalence() %>% 
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU") 

BKIS_proj1_Q16705_prevalence =
  left_join(BKIS_proj1_Q16705, physeq_BKIS_proj1_Q16705_no_mock, by = "OTU") %>% 
  select(OTU, Sample, Abundance, prevalence, everything())

# OBER_proj3_Q15250
OBER_proj3_Q15250 = 
  physeq_OBER_proj3_Q15250 %>% 
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>% 
  #prune_taxa(taxa_sums(.)>0.01, .) %>% # 
  psmelt() %>% 
  as_tibble() %>% 
  mutate(study = "OBER_proj3_Q15250")

# filter mock out and at prevalence 
physeq_OBER_proj3_Q15250_no_mock = 
physeq_OBER_proj3_Q15250 %>% 
  subset_samples(., Sample_mock == "sample") %>% 
  prune_taxa(taxa_sums(.)>0, .) %>% 
  microbiome::prevalence() %>% 
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU") 

OBER_proj3_Q15250_prevalence =
  left_join(OBER_proj3_Q15250, physeq_OBER_proj3_Q15250_no_mock, by = "OTU") %>% 
  select(OTU, Sample, Abundance, prevalence, everything())

# OSOJ_proj3_Q16374
OSOJ_proj3_Q16374 = 
  physeq_OSOJ_proj3_Q16374 %>% 
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>% 
  #prune_taxa(taxa_sums(.)>0.01, .) %>% # 
  psmelt() %>% 
  as_tibble() %>% 
  mutate(study = "OSOJ_proj3_Q16374")

# filter mock out and at prevalence 
physeq_OSOJ_proj3_Q16374_no_mock = 
physeq_OSOJ_proj3_Q16374 %>% 
  subset_samples(., Sample_mock == "sample") %>% 
  prune_taxa(taxa_sums(.)>0, .) %>% 
  microbiome::prevalence() %>% 
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU") 

OSOJ_proj3_Q16374_prevalence =
  left_join(OSOJ_proj3_Q16374, physeq_OSOJ_proj3_Q16374_no_mock, by = "OTU") %>% 
  select(OTU, Sample, Abundance, prevalence, everything())

# OSOJ_proj4_Q17230
OSOJ_proj4_Q17230 = 
  physeq_OSOJ_proj4_Q17230 %>% 
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>% 
  #prune_taxa(taxa_sums(.)>0.01, .) %>% # 
  psmelt() %>% 
  as_tibble() %>% 
  mutate(study = "OSOJ_proj4_Q17230")

# filter mock out and at prevalence 
physeq_OSOJ_proj4_Q17230_no_mock = 
physeq_OSOJ_proj4_Q17230 %>% 
  subset_samples(., Sample_mock == "sample") %>% 
  prune_taxa(taxa_sums(.)>0, .) %>% 
  microbiome::prevalence() %>% 
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU") 

OSOJ_proj4_Q17230_prevalence =
  left_join(OSOJ_proj4_Q17230, physeq_OSOJ_proj4_Q17230_no_mock, by = "OTU") %>% 
  select(OTU, Sample, Abundance, prevalence, everything())

# OSOJ_proj5_Q17229
OSOJ_proj5_Q17229 = 
  physeq_OSOJ_proj5_Q17229 %>% 
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>% 
  #prune_taxa(taxa_sums(.)>0.01, .) %>% # 
  psmelt() %>% 
  as_tibble() %>% 
  mutate(study = "OSOJ_proj5_Q17229")

# filter mock out and at prevalence 
physeq_OSOJ_proj5_Q17229_no_mock = 
physeq_OSOJ_proj5_Q17229 %>% 
  subset_samples(., Sample_mock == "sample") %>% 
  prune_taxa(taxa_sums(.)>0, .) %>% 
  microbiome::prevalence() %>% 
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU") 

OSOJ_proj5_Q17229_prevalence =
  left_join(OSOJ_proj5_Q17229, physeq_OSOJ_proj5_Q17229_no_mock, by = "OTU") %>% 
  select(OTU, Sample, Abundance, prevalence, everything())

# SHSU_proj1_Q17228
SHSU_proj1_Q17228 = 
  physeq_SHSU_proj1_Q17228 %>% 
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>% 
  #prune_taxa(taxa_sums(.)>0.01, .) %>% # 
  psmelt() %>% 
  as_tibble() %>% 
  mutate(study = "SHSU_proj1_Q17228")

# filter mock out and at prevalence 
physeq_SHSU_proj1_Q17228_no_mock = 
physeq_SHSU_proj1_Q17228 %>% 
  subset_samples(., Sample_mock == "sample") %>% 
  prune_taxa(taxa_sums(.)>0, .) %>% 
  microbiome::prevalence() %>% 
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU") 

SHSU_proj1_Q17228_prevalence =
  left_join(SHSU_proj1_Q17228, physeq_SHSU_proj1_Q17228_no_mock, by = "OTU") %>% 
  select(OTU, Sample, Abundance, prevalence, everything())

# YLUO_projx_Q12374
YLUO_projx_Q12374 = 
  physeq_YLUO_projx_Q12374 %>% 
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>% 
  #prune_taxa(taxa_sums(.)>0.01, .) %>% # 
  psmelt() %>% 
  as_tibble() %>% 
  mutate(study = "YLUO_projx_Q12374")

# filter mock out and at prevalence 
physeq_YLUO_projx_Q12374_no_mock = 
physeq_YLUO_projx_Q12374 %>% 
  subset_samples(., Sample_mock == "sample") %>% 
  prune_taxa(taxa_sums(.)>0, .) %>% 
  microbiome::prevalence() %>% 
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU") 

YLUO_projx_Q12374_prevalence =
  left_join(YLUO_projx_Q12374, physeq_YLUO_projx_Q12374_no_mock, by = "OTU") %>% 
  select(OTU, Sample, Abundance, prevalence, everything())

# YXIN_proj1_Q16712
YXIN_proj1_Q16712 = 
  physeq_YXIN_proj1_Q16712 %>% 
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>% 
  #prune_taxa(taxa_sums(.)>0.01, .) %>% # 
  psmelt() %>% 
  as_tibble() %>% 
  mutate(study = "YXIN_proj1_Q16712")

# filter mock out and at prevalence 
physeq_YXIN_proj1_Q16712_no_mock = 
physeq_YXIN_proj1_Q16712 %>% 
  subset_samples(., Sample_mock == "sample") %>% 
  prune_taxa(taxa_sums(.)>0, .) %>% 
  microbiome::prevalence() %>% 
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU") 

YXIN_proj1_Q16712_prevalence =
  left_join(YXIN_proj1_Q16712, physeq_YXIN_proj1_Q16712_no_mock, by = "OTU") %>% 
  select(OTU, Sample, Abundance, prevalence, everything()) 

# KJOH_proj04_Q17535
KJOH_proj04_Q17535 =
  physeq_KJOH_proj04_Q17535 %>%
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>%
  #prune_taxa(taxa_sums(.)>0.01, .) %>% #
  psmelt() %>%
  as_tibble() %>%
  mutate(study = "KJOH_proj04_Q17535")

# filter mock out and at prevalence
physeq_KJOH_proj04_Q17535_no_mock =
physeq_KJOH_proj04_Q17535 %>%
  subset_samples(., Sample_mock == "sample") %>%
  prune_taxa(taxa_sums(.)>0, .) %>%
  microbiome::prevalence() %>%
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU")

KJOH_proj04_Q17535_prevalence =
  left_join(KJOH_proj04_Q17535, physeq_KJOH_proj04_Q17535_no_mock, by = "OTU") %>%
  select(OTU, Sample, Abundance, prevalence, everything())

# KJOH_proj05_Q17536
KJOH_proj05_Q17536 =
  physeq_KJOH_proj05_Q17536 %>%
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>%
  #prune_taxa(taxa_sums(.)>0.01, .) %>% #
  psmelt() %>%
  as_tibble() %>%
  mutate(study = "KJOH_proj05_Q17536")

# filter mock out and at prevalence 
physeq_KJOH_proj05_Q17536_no_mock =
physeq_KJOH_proj05_Q17536 %>%
  subset_samples(., Sample_mock == "sample") %>%
  prune_taxa(taxa_sums(.)>0, .) %>%
  microbiome::prevalence() %>%
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU")

KJOH_proj05_Q17536_prevalence =
  left_join(KJOH_proj05_Q17536, physeq_KJOH_proj05_Q17536_no_mock, by = "OTU") %>%
  select(OTU, Sample, Abundance, prevalence, everything())

# KJOH_proj06_Q17537
KJOH_proj06_Q17537 =
  physeq_KJOH_proj06_Q17537 %>%
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>%
  #prune_taxa(taxa_sums(.)>0.01, .) %>% #
  psmelt() %>%
  as_tibble() %>%
  mutate(study = "KJOH_proj06_Q17537")

# filter mock out and at prevalence
physeq_KJOH_proj06_Q17537_no_mock =
physeq_KJOH_proj06_Q17537 %>%
  subset_samples(., Sample_mock == "sample") %>%
  prune_taxa(taxa_sums(.)>0, .) %>%
  microbiome::prevalence() %>%
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU")

KJOH_proj06_Q17537_prevalence =
  left_join(KJOH_proj06_Q17537, physeq_KJOH_proj06_Q17537_no_mock, by = "OTU") %>%
  select(OTU, Sample, Abundance, prevalence, everything())

# External data

# PRJEB34118
PRJEB34118 =
  physeq_PRJEB34118 %>%
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>%
  #prune_taxa(taxa_sums(.)>0.01, .) %>% #
  psmelt() %>%
  as_tibble() %>%
  filter(!SampleID %in% c("ERR3494157", "ERR3494173", "ERR3494185", "ERR3494197")) %>%
  select(-Sample_name) %>% 
  mutate(study = "PRJEB34118")

# filter mock out and at prevalence
physeq_PRJEB34118_no_mock =
physeq_PRJEB34118 %>%
  subset_samples(., Sample_mock == "sample") %>%
  prune_taxa(taxa_sums(.)>0, .) %>%
  microbiome::prevalence() %>%
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU")

PRJEB34118_prevalence =
  left_join(PRJEB34118, physeq_PRJEB34118_no_mock, by = "OTU") %>%
  select(OTU, Sample, Abundance, prevalence, everything())

# PRJNA862376
PRJNA862376 =
  physeq_PRJNA862376 %>%
  transform_sample_counts(., fun = function(x) x/sum(x)*100) %>%
  #prune_taxa(taxa_sums(.)>0.01, .) %>% #
  psmelt() %>%
  as_tibble() %>%
  mutate(study = "PRJNA862376")

# filter mock out and at prevalence
physeq_PRJNA862376_no_mock =
physeq_PRJNA862376 %>%
  subset_samples(., Sample_mock == "sample") %>%
  prune_taxa(taxa_sums(.)>0, .) %>%
  microbiome::prevalence() %>%
  data.frame(prevalence = .) %>%
  tibble::rownames_to_column(var = "OTU")

PRJNA862376_prevalence =
  left_join(PRJNA862376, physeq_PRJNA862376_no_mock, by = "OTU") %>%
  select(OTU, Sample, Abundance, prevalence, everything())

# List all studies 
Inhouse_wetsus_2022_studies <- list(BKIS_proj1_Q16705_prevalence, OBER_proj3_Q15250_prevalence, OSOJ_proj3_Q16374_prevalence)
bind_rows(Inhouse_wetsus_2022_studies)

Inhouse_wetsus_2023_studies <- list(BKIS_proj1_Q16705_prevalence, OSOJ_proj4_Q17230_prevalence, OSOJ_proj5_Q17229_prevalence, SHSU_proj1_Q17228_prevalence, YXIN_proj1_Q16712_prevalence, KJOH_proj04_Q17535_prevalence, KJOH_proj05_Q17536_prevalence, KJOH_proj06_Q17537_prevalence)
bind_rows(Inhouse_wetsus_2023_studies)

Zymo_log10_studies <- list(YLUO_projx_Q12374_prevalence)
bind_rows(Zymo_log10_studies)

Zymo_equil_studies <- list(OBER_proj3_Q15250_prevalence, PRJNA862376_prevalence, PRJEB34118_prevalence)
bind_rows(Zymo_equil_studies)

all_studies <- list(BKIS_proj1_Q16705_prevalence, OBER_proj3_Q15250_prevalence, OSOJ_proj3_Q16374_prevalence, OSOJ_proj4_Q17230_prevalence, OSOJ_proj5_Q17229_prevalence, SHSU_proj1_Q17228_prevalence, YLUO_projx_Q12374_prevalence, YXIN_proj1_Q16712_prevalence, PRJNA862376_prevalence, PRJEB34118_prevalence, KJOH_proj04_Q17535_prevalence, KJOH_proj05_Q17536_prevalence, KJOH_proj06_Q17537_prevalence)
```

```{r subset mock communities, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
# Table of mock composition
Zymo_log10 =
  tibble(Genus = c("Listeria",
                   "Pseudomonas",
                   "Bacillus",
                   "Saccharomyces",
                   "Escherichia-Shigella",
                   "Salmonella",
                   "Lactobacillus",
                   "Enterococcus",
                   "Cryptococcus",
                   "Staphylococcus"),
         zymo_abund = c(
                   95.9,
                   2.8,
                   1.2,
                   0,
                   0.069,
                   0.07,
                   0.012,
                   0.00067,
                   0,
                   0.0001))

Zymo_equil =
  tibble(Genus = c("Pseudomonas", 
                   "Escherichia-Shigella", 
                   "Salmonella",
                   "Lactobacillus", 
                   "Enterococcus", 
                   "Staphylococcus", 
                   "Listeria", 
                   "Bacillus", 
                   "Saccharomyces", 
                   "Cryptococcus"),
         zymo_abund = c(
                   4.2,
                   10.1,
                   10.4,
                   18.4,
                   9.9,
                   15.5,
                   14.1,
                   17.4,
                   0,
                   0)) 

Inhouse2022_correct =
  tibble(Genus = c("Brevibacillus",
                   "Bacillus",
                   "Lysinibacillus",
                   "Bordetella"),
         Inhouse2022_abund = c(
                   55.17,
                   36.21,
                   6.90,
                   1.72))

Inhouse2023 =
  tibble(Genus = c("Brevibacillus",
                   "Bacillus",
                   "Lysinibacillus",
                   "Sphingobium",
                   "Streptomyces",
                   "Burkholderia-Caballeronia-Paraburkholderia"),
         Inhouse2023_abund = c(
                   50.78,
                   31.73,
                   12.69,
                   3.18,
                   0.79,
                   0.40))
```

```{r sample en mock namen, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
# filter names of mock samples
mock_names_inhouse_wetsus_2022 = 
  Inhouse_wetsus_2022_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "mock") %>%
  distinct(Sample)
  }) %>%
  bind_rows()

mock_names_inhouse_wetsus_2023 = 
  Inhouse_wetsus_2023_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "mock") %>%
  distinct(Sample)
  }) %>%
  bind_rows()

mock_names_zymo_log10 = 
  Zymo_log10_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "mock") %>%
  distinct(Sample)
  }) %>%
  bind_rows()

mock_names_zymo_equil = 
  Zymo_equil_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "mock") %>%
  distinct(Sample)
  }) %>%
  bind_rows()

# filter sample names
sample_names_inhouse_wetsus_2022 =
  Inhouse_wetsus_2022_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "sample") %>%
  distinct(Sample)
  }) %>%
  bind_rows()

sample_names_inhouse_wetsus_2023 = 
  Inhouse_wetsus_2023_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "sample") %>%
  distinct(Sample)
  }) %>%
  bind_rows()

sample_names_zymo_log10 = 
  Zymo_log10_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "sample") %>%
  distinct(Sample)
  }) %>%
  bind_rows()

sample_names_zymo_equil = 
  Zymo_equil_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "sample") %>%
  distinct(Sample)
  }) %>%
  bind_rows()
```

```{r mock bar plot, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
# barplot for mock communities

# inhouse_mock_2022
mock_only_Inhouse_wetsus_2022_samples =
  Inhouse_wetsus_2022_studies %>%
  lapply(function(df) {
    df %>%
  filter(!Sample %in% c("MCZ", "MC23")) %>%
  filter(Sample_mock == "mock") %>% 
  mutate(Genus = ifelse(Genus %in% Inhouse2022_correct$Genus, Genus, "Other genera")) %>% 
  mutate(Genus = factor(Genus, levels = c(setdiff(unique(Genus), "Other genera"), "Other genera")))
  }) %>% 
  bind_rows()

# inhouse_mock_2023
mock_only_Inhouse_wetsus_2023_samples =
  Inhouse_wetsus_2023_studies %>%
  lapply(function(df) {
    df %>%
  filter(!Sample %in% c("MCZ", "MC22")) %>%
  filter(Sample_mock == "mock") %>% 
  mutate(Genus = ifelse(Genus %in% Inhouse2023$Genus, Genus, "Other genera")) %>% 
  mutate(Genus = factor(Genus, levels = c(setdiff(unique(Genus), "Other genera"), "Other genera")))
  }) %>% 
  bind_rows()

# zymo_log10
mock_only_zymo_log10_samples =
  Zymo_log10_studies %>%
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "mock") %>% 
  mutate(Genus = ifelse(Genus %in% Zymo_log10$Genus, Genus, "Other genera")) %>% 
  mutate(Genus = factor(Genus, levels = c(setdiff(unique(Genus), "Other genera"), "Other genera")))
  }) %>% 
  bind_rows()

# zymo_equil
mock_only_zymo_equil_samples =
  Zymo_equil_studies %>%
  lapply(function(df) {
    df %>%
  filter(!Sample %in% c("MCL1", "MCL2")) %>%
  filter(Sample_mock == "mock") %>% 
  mutate(Genus = ifelse(Genus %in% Zymo_equil$Genus, Genus, "Other genera")) %>% 
  mutate(Genus = factor(Genus, levels = c(setdiff(unique(Genus), "Other genera"), "Other genera")))
  }) %>% 
  bind_rows()

# bind all mocks 
all_mock_studies =
  rbind(mock_only_Inhouse_wetsus_2022_samples, 
        mock_only_Inhouse_wetsus_2023_samples, 
        mock_only_zymo_log10_samples,
        mock_only_zymo_equil_samples
        ) %>% 
  arrange(Source_mock) %>% 
  mutate(Sample = factor(Sample, levels = unique(Sample))) %>% 
  mutate(Genus = factor(Genus, levels = c(setdiff(levels(Genus), "Other genera"), "Other genera")))

unique_genera <- levels(all_mock_studies$Genus)

# Colors
genus_colors <- scales::hue_pal()(length(unique_genera) - 1)
names(genus_colors) <- unique_genera[unique_genera != "Other genera"]
genus_colors["Other genera"] <- "grey"

bar_plot_all_mock_studies =
  all_mock_studies %>% 
  ggplot(aes(x = Sample , y = Abundance, fill = Genus)) +
  geom_bar(position= "stack", stat = "identity") +
  scale_fill_manual(values = genus_colors) +
  facet_grid(cols = vars(Source_mock),  scales = "free_x", space = "free_x") +
  theme_minimal() +
  labs(x = "Mock samples", y = "Abundance (%)", fill = "Genus") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 14),
                                   axis.text.y = element_text(size = 14),
                                   strip.text = element_text(size = 8),
                                   legend.text = element_text(size = 15),
                                   legend.title = element_text(size = 16),
                                   axis.title.x = element_text(size = 14),
                                   axis.title.y = element_text(size = 14),)

ggsave("figures/bar_plot_all_mock_studies.pdf", plot = bar_plot_all_mock_studies, width = 18, height = 10)
ggsave("figures/bar_plot_all_mock_studies.jpg", plot = bar_plot_all_mock_studies, width = 18, height = 10)

bar_plot_all_mock_studies

Genus_abundance_all_mock_studies = 
  all_mock_studies %>% 
  group_by(Sample, Genus) %>%
  summarize(total_abundance = sum(Abundance))
#view(Genus_abundance_all_mock_studies)

```

```{r view genera in the mock}
# view all genera in mock
# mock_only_Inhouse_wetsus_2022_samples %>%
#   filter(abund > 0) %>%
#   select(Genus) %>%
#   unique %>%
#   view()
# 
# Inhouse_wetsus_2022_studies %>%
#   bind_rows() %>%
#   filter(Abundance > 0) %>%
#   filter(Sample_mock == "mock") %>%
#   filter(Source_mock == "inhouse_wetsus_2022") %>%
#   select(Genus, Abundance, everything()) %>%
#   unique %>%
#   view()
# 
# mock_only_zymo_log10_samples %>%
#   filter(abund > 0) %>%
#   select(Genus) %>%
#   unique %>%
#   view()
# 
# mock_only_zymo_equil_samples %>%
#   filter(abund > 0) %>%
#   select(Genus) %>%
#   unique %>%
#   view()

# Zymo_equil_studies %>%
#   bind_rows() %>%
#   filter(Sample_mock == "mock") %>%
#   select(Abundance, Genus, OTU, study) %>%
#   filter(Abundance > 0) %>%
#   unique %>%
#   view()
```

```{r abudance theoretical vs measured, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
# inhouse wetsus 2022
table_measured_vs_theoretical_inhouse_wetsus_2022 =
  mock_only_Inhouse_wetsus_2022_samples %>%
  select(Sample, Abundance, Source_mock, Genus) %>%
  group_by(Sample, Genus) %>%
  summarise(sum_abund_inhouse_wetsus_2022 = sum(Abundance), 
            .groups = 'drop') %>%
  inner_join(Inhouse2022_correct, by = ("Genus"))

measured_vs_theoretical_inhouse_wetsus_2022 =
  table_measured_vs_theoretical_inhouse_wetsus_2022 %>% 
  ggplot(aes(x = Inhouse2022_abund, 
             y = sum_abund_inhouse_wetsus_2022)) +
  geom_point(aes(color = Sample, alpha = Genus), alpha = 0.5) +
  geom_smooth(method = "lm", se = F, aes(group = Sample, color = Sample), alpha = 0.5) +
  geom_mark_ellipse(aes(group = Genus, label = Genus), label.fontsize = 11, 
                    expand = unit(3, "mm")) +
  labs(title = "Inhouse wetsus 2022",
       x = "Theoretical Abundance (%)",
       y = "Measured Abundance (%)") +
  theme_minimal() +
  theme(legend.position = "right") +
  ylim(0, NA)


ggsave("figures/measured_vs_theoretical_inhouse_wetsus_2022.pdf", plot = measured_vs_theoretical_inhouse_wetsus_2022, width = 8, height = 5)
ggsave("figures/measured_vs_theoretical_inhouse_wetsus_2022.jpg", plot = measured_vs_theoretical_inhouse_wetsus_2022, width = 8, height = 5)

measured_vs_theoretical_inhouse_wetsus_2022

abundance_difference_inhouse_wetsus_2022 =
  table_measured_vs_theoretical_inhouse_wetsus_2022$mean_abund_inhouse_wetsus_2022 -     table_measured_vs_theoretical_inhouse_wetsus_2022$Inhouse2022_abund

#t_test_result <- t.test(abundance_difference_inhouse_wetsus_2022)

# inhouse wetsus 2023
table_measured_vs_theoretical_inhouse_wetsus_2023 =
  mock_only_Inhouse_wetsus_2023_samples %>%
  select(Sample, Abundance, Source_mock, Genus) %>%
  group_by(Sample, Genus) %>%
  summarise(sum_abund_inhouse_wetsus_2023 = sum(Abundance), 
            .groups = 'drop') %>%
  inner_join(Inhouse2023, by = ("Genus"))

measured_vs_theoretical_inhouse_wetsus_2023 =
  table_measured_vs_theoretical_inhouse_wetsus_2023 %>% 
  ggplot(aes(x = Inhouse2023_abund, 
             y = sum_abund_inhouse_wetsus_2023)) +
  geom_point(aes(color = Sample, alpha = Genus), alpha = 0.5) +
  geom_mark_ellipse(aes(group = Genus, label = Genus), label.fontsize = 11, 
                    expand = unit(3, "mm")) +
  labs(title = "Inhouse wetsus 2023",
       x = "Theoretical Abundance (%)",
       y = "Measured Abundance (%)") +
  theme_minimal() +
  theme(legend.position = "right") +
  ylim(-5, NA) +
  geom_smooth(method = "lm", se = FALSE, aes(group = Sample, color = Sample), alpha = 0.5)

ggsave("figures/measured_vs_theoretical_inhouse_wetsus_2023.pdf", plot = measured_vs_theoretical_inhouse_wetsus_2023, width = 8, height = 5)
ggsave("figures/measured_vs_theoretical_inhouse_wetsus_2023.jpg", plot = measured_vs_theoretical_inhouse_wetsus_2023, width = 8, height = 5)

measured_vs_theoretical_inhouse_wetsus_2023

abundance_difference_inhouse_wetsus_2023 =
  table_measured_vs_theoretical_inhouse_wetsus_2023$mean_abund_inhouse_wetsus_2023 -     table_measured_vs_theoretical_inhouse_wetsus_2023$Inhouse2023_abund

# zymo_log10
table_measured_vs_theoretical_zymo_log10 =
  mock_only_zymo_log10_samples %>%
  select(Sample, Abundance, Source_mock, Genus) %>%
  group_by(Sample, Genus) %>%
  summarise(sum_abund_zymo_log10 = sum(Abundance), 
            .groups = 'drop') %>%
  inner_join(Zymo_log10, by = ("Genus"))

measured_vs_theoretical_zumo_log10 =
  table_measured_vs_theoretical_zymo_log10 %>% 
  ggplot(aes(x = zymo_abund,
             y = sum_abund_zymo_log10+0.00001)) +
  geom_point(aes(color = Sample, alpha = Genus), alpha = 0.5) +
  scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)),
                limits = c(0.00001, 100)) +
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)),
                limits = c(0.00001, 100)) +
  geom_mark_ellipse(aes(group = Genus, label = Genus), label.fontsize = 11, 
                    expand = unit(3, "mm")) +
  labs(title = "Zymo_log10",
       x = "Theoretical Abundance (%)",
       y = "Measured Abundance (%)") +
  theme_minimal() +
  theme(legend.position = "right") +
  geom_smooth(method = "lm", se = FALSE, aes(group = Sample, color = Sample), alpha = 0.5)
  
ggsave("figures/measured_vs_theoretical_zumo_log10.pdf", plot = measured_vs_theoretical_zumo_log10, width = 8, height = 5)
ggsave("figures/measured_vs_theoretical_zumo_log10.jpg", plot = measured_vs_theoretical_zumo_log10, width = 8, height = 5)

measured_vs_theoretical_zumo_log10

abundance_difference_zymo_log10 =
  table_measured_vs_theoretical_zymo_log10$mean_abund_zymo_log10 - table_measured_vs_theoretical_zymo_log10$zymo_abund

# zymo_equil
table_measured_vs_theoretical_zymo_equil =
  mock_only_zymo_equil_samples %>%
  select(Sample, Abundance, Source_mock, Genus) %>%
  group_by(Sample, Genus) %>%
  summarise(sum_abund_zymo_equil = sum(Abundance), 
            .groups = 'drop') %>%
  inner_join(Zymo_equil, by = ("Genus"))

measured_vs_theoretical_zymo_equil =
  table_measured_vs_theoretical_zymo_equil %>% 
  ggplot(aes(x = zymo_abund,
             y = sum_abund_zymo_equil)) +
  geom_mark_ellipse(aes(group = Genus, label = Genus), 
                    label.fontsize = 9, 
                    expand = unit(2, "mm"),) +
  geom_smooth(method = "lm", se = F, aes(group = Sample, color = Sample), alpha = 0.5) +
  geom_point(aes(color = Sample, alpha = Genus), alpha = 0.5) +
  labs(title = "Zymo_equil",
       x = "Theoretical Abundance (%)",
       y = "Measured Abundance (%)") +
  theme_minimal() +
  theme(legend.position = "right") +
  xlim(0, 30) +
  ylim(-5, 50)

ggsave("figures/measured_vs_theoretical_zymo_equil.pdf", plot = measured_vs_theoretical_zymo_equil, width = 8, height = 5)
ggsave("figures/measured_vs_theoretical_zymo_equil.jpg", plot = measured_vs_theoretical_zymo_equil, width = 8, height = 5)

measured_vs_theoretical_zymo_equil
```

```{r Prevalence berekenen, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
# Correct all studies
all_studies_corrected =
  all_studies %>% 
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "sample") %>% 
  mutate(Sample = if_else(str_sub(Sample, -1)== "C", str_replace(Sample, "C$", ""), Sample)) %>% 
  group_by(across(-c(SampleID, Abundance, read_count))) %>% 
  summarise(mean_abundance = mean(Abundance), 
            mean_read_count = mean(read_count), 
            mean_dna_conc = mean(DNA_Concentration), 
            .groups = "drop") %>% 
  distinct() %>% 
  group_by(Sample, Genus, study, OTU) %>%   
  summarise(abund = sum(mean_abundance),
            readcount = sum(mean_read_count),
            dnaconc = mean(mean_dna_conc),
            .groups = "drop") %>% 
  group_by(study) %>% 
  arrange(study, desc(abund))
  })

all_studies_mock_corrected =
  all_studies %>% 
  lapply(function(df) {
    df %>%
  filter(Sample_mock == "mock") %>% 
  group_by(Sample, Genus, study, OTU) %>%   
  summarise(abund = sum(Abundance),
            readcount = sum(read_count),
            dnaconc = mean(DNA_Concentration),
            .groups = "drop") %>% 
  group_by(study) %>% 
  arrange(study, desc(abund))
  })

# calculate mean, median and max abundace 
all_studies_table =
  all_studies_corrected %>% 
  lapply(function(df) {
    df %>%
  select(study, Sample, OTU, abund) %>% 
  group_by(study, OTU) %>% 
  summarise(mean_abund = mean(abund),
            median_abund = median(abund),
            max_abund = max(abund),
            .groups = "drop") %>% 
  arrange(desc(mean_abund))
  }) %>% 
  bind_rows()

# calculate mean, median and max sample dna concentration 
all_studies_table_dnaconc_sample =
  all_studies_corrected %>% 
  lapply(function(df) {
    df %>%
  select(study, Sample, dnaconc) %>% 
  group_by(study) %>% 
  summarise(mean_dnaconc = mean(dnaconc),
            median_dnaconc = median(dnaconc),
            max_dnaconc = max(dnaconc),
            .groups = "drop") %>% 
  arrange(desc(mean_dnaconc))
  }) %>% 
  bind_rows() %>% 
  mutate(sample_mock = "sample") %>% 
  pivot_longer(cols = c(-study, -sample_mock), names_to = "dna_char", values_to = "dna_value")

# calculate mean, median and max mock dna concentration 
all_studies_table_dnaconc_mock =
  all_studies_mock_corrected %>% 
  lapply(function(df) {
    df %>%
  select(study, Sample, dnaconc) %>% 
  group_by(study) %>% 
  summarise(mean_dnaconc = mean(dnaconc),
            median_dnaconc = median(dnaconc),
            max_dnaconc = max(dnaconc),
            .groups = "drop") %>% 
  arrange(desc(mean_dnaconc))
  }) %>% 
  bind_rows() %>% 
  mutate(sample_mock = "mock") %>% 
  pivot_longer(cols = c(-study, -sample_mock), names_to = "dna_char", values_to = "dna_value")

# Filter the mock samples from the studies
mock_only_inhouse_2022_BKIS_proj1_Q16705 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "BKIS_proj1_Q16705") %>% 
  filter(Sample_mock == "mock") %>%
  filter(Sample != "MC23") %>% 
  filter(!(Genus %in% Inhouse2022_correct$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_inhouse_2023_BKIS_proj1_Q16705 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "BKIS_proj1_Q16705") %>% 
  filter(Sample_mock == "mock") %>%
  filter(Sample != "MC22") %>% 
  filter(!(Genus %in% Inhouse2023$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_inhouse_2022_OBER_proj3_Q15250 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "OBER_proj3_Q15250") %>% 
  filter(Sample_mock == "mock") %>%
  filter(Sample != "MCZ") %>% 
  filter(!(Genus %in% Inhouse2022_correct$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_zymo_OBER_proj3_Q15250 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "OBER_proj3_Q15250") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!Sample %in% c("MC1", "MC2")) %>% 
  filter(!(Genus %in% Zymo_equil$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_OSOJ_proj3_Q16374 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "OSOJ_proj3_Q16374") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Inhouse2022_correct$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_OSOJ_proj4_Q17230 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "OSOJ_proj4_Q17230") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Inhouse2023$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_OSOJ_proj5_Q17229 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "OSOJ_proj5_Q17229") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Inhouse2023$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_SHSU_proj1_Q17228 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "SHSU_proj1_Q17228") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Inhouse2023$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_YLUO_projx_Q12374 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "YLUO_projx_Q12374") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Zymo_log10$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_YXIN_proj1_Q16712 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "YXIN_proj1_Q16712") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Inhouse2023$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_KJOH_proj04_Q17535 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "KJOH_proj04_Q17535") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Inhouse2023$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_KJOH_proj05_Q17536 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "KJOH_proj05_Q17536") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Inhouse2023$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_KJOH_proj06_Q17537 =
  all_studies %>% 
  bind_rows() %>%
  filter(study == "KJOH_proj06_Q17537") %>% 
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Inhouse2023$Genus)) %>% 
  arrange(desc(Abundance)) %>% 
  select(study, OTU, Abundance, prevalence) %>% 
  inner_join(., all_studies_table, by = c("study", "OTU")) %>% 
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_PRJEB34118 =
  all_studies %>%
  bind_rows() %>%
  filter(study == "PRJEB34118") %>%
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Zymo_equil$Genus)) %>%
  arrange(desc(Abundance)) %>%
  select(study, OTU, Abundance, prevalence) %>%
  inner_join(., all_studies_table, by = c("study", "OTU")) %>%
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

mock_only_PRJNA862376 =
  all_studies %>%
  bind_rows() %>%
  filter(study == "PRJNA862376") %>%
  filter(Sample_mock == "mock") %>%
  filter(!(Genus %in% Zymo_equil$Genus)) %>%
  arrange(desc(Abundance)) %>%
  select(study, OTU, Abundance, prevalence) %>%
  inner_join(., all_studies_table, by = c("study", "OTU")) %>%
  pivot_longer(cols = c(prevalence, mean_abund, median_abund, max_abund),names_to = "sample_char", values_to = "value")

# List all studies together
all_studies_list =
  list(mock_only_inhouse_2022_BKIS_proj1_Q16705, mock_only_inhouse_2023_BKIS_proj1_Q16705,
       mock_only_inhouse_2022_OBER_proj3_Q15250, mock_only_zymo_OBER_proj3_Q15250, mock_only_OSOJ_proj3_Q16374,
       mock_only_OSOJ_proj4_Q17230, mock_only_OSOJ_proj5_Q17229, mock_only_SHSU_proj1_Q17228, mock_only_YLUO_projx_Q12374,
       mock_only_YXIN_proj1_Q16712, mock_only_PRJEB34118, mock_only_PRJNA862376, mock_only_KJOH_proj04_Q17535,
       mock_only_KJOH_proj05_Q17536, mock_only_KJOH_proj06_Q17537) %>% 
  bind_rows()
```

```{r Prevalence plotten, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE, fig.width=9, fig.height=5}
# plot prevalaence; median 
all_studies_plot_prevalence_median_prevalence =
  all_studies_list %>%
  filter(sample_char %in% c("prevalence", "median_abund")) %>% 
  ggplot(aes(x=value, y=Abundance, shape = sample_char)) +
  geom_point(aes(color = study), size = 1.1, alpha = 0.7) +
  ylim(0, 1.5) +
  stat_smooth(aes(group = study, color = study), method = "lm", se = T) +
  facet_wrap(~sample_char, nrow = 2, ncol = 4, scales = "free") +
  labs(y="Percentage Sample ASV in mock community")

ggsave("figures/prevalence_median_prevalence.pdf", plot = all_studies_plot_prevalence_median_prevalence, width = 9, height = 5)
ggsave("figures/prevalence_median_prevalence.jpg", plot = all_studies_plot_prevalence_median_prevalence, width = 9, height = 5)

all_studies_plot_prevalence_median_prevalence

# plot prevalaence 
all_studies_plot_prevalence =
  all_studies_list %>% 
  ggplot(aes(x=value, y=Abundance, shape = sample_char)) +
  geom_point(aes(color = study), size = 1.1, alpha = 0.7) +
  ylim(0, 1.5) +
  stat_smooth(aes(group = study, color = study), method = "lm", se = T) +
  facet_wrap(~sample_char, nrow = 2, ncol = 4, scales = "free") +
  labs(y="Percentage Sample ASV in mock community")

ggsave("figures/prevalence.pdf", plot = all_studies_plot_prevalence, width = 9, height = 5)
ggsave("figures/prevalence.jpg", plot = all_studies_plot_prevalence, width = 9, height = 5)

all_studies_plot_prevalence
```

```{r prevalence statstiek}
# p value 
# overall linear regression test (Study random variable)
statistic_all_studies =
  all_studies_list %>% 
  filter(sample_char == "median_abund") %>%  
  with(lm(Abundance ~ value * study))

# anova
anova(statistic_all_studies)

# overall linear regression test (Study random variable)
statistic_all_studies_2 =
  all_studies_list %>% 
  filter(sample_char == "prevalence") %>% 
  with(lm(Abundance ~ value * study))

# anova
anova(statistic_all_studies_2)

#significant interaction 

# pairwise comparison of slopes among sample characters
emmeans::emtrends(statistic_all_studies, pairwise ~ study, var = "value")

# notatie = (anova: F12,56776 = 5255.74, p < 10^-15)
```


```{r contaminant slopes, eval=TRUE, echo=TRUE, include=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
lm_sample_contaminants = 
  all_studies_list %>% 
  with(lm(Abundance~study*sample_char*value)) 

anova(lm_sample_contaminants)

trends = 
  emmeans::emtrends(lm_sample_contaminants, ~study*sample_char, var = "value") %>% 
    as_tibble() %>% 
    filter(lower.CL > 0)

# calculate differences
abund_dna_char = 
bind_rows(all_studies_table_dnaconc_mock, all_studies_table_dnaconc_sample) %>% 
  pivot_wider(names_from = sample_mock, values_from = dna_value) %>% 
  mutate(dna_char_ratio = mock/sample,
         dna_char_diff = mock - sample) %>% 
  inner_join(., trends, by = "study", relationship = "many-to-many")

ratio_abund_dna_char_plot_prevalence_median =
  abund_dna_char %>% 
  filter(dna_char == "median_dnaconc") %>% 
  ggplot(aes(x = dna_char_ratio, y = value.trend)) +
  geom_point(aes(color = dna_char, shape = sample_char)) +
  geom_smooth(method="lm", se=T) +
  scale_x_log10() +
  labs(x = "Ratio DNA concentration (mock/sample)", y = "Trend") +
  facet_grid(rows = vars(dna_char), cols = vars(sample_char))

ggsave("figures/ratio_abund_dna_char_plot_prevalence_median.pdf", 
       plot = ratio_abund_dna_char_plot_prevalence_median, width = 9, height = 5)
ggsave("figures/ratio_abund_dna_char_plot_prevalence_median.jpg", 
       plot = ratio_abund_dna_char_plot_prevalence_median, width = 9, height = 5)

ratio_abund_dna_char_plot_prevalence_median

diff_abund_dna_char_plot_prevalence_median =
  abund_dna_char %>%
  filter(dna_char == "median_dnaconc") %>% 
  ggplot(aes(x = dna_char_diff, y = value.trend)) +
  geom_point(aes(color = dna_char, shape = sample_char)) +
  geom_smooth(method="lm", se=T) +
  labs(x = "Difference DNA concentration (mock-sample) (ng/l)", y = "Trend") +
  facet_grid(rows = vars(dna_char), cols = vars(sample_char))

ggsave("figures/diff_abund_dna_char_plot_prevalence_median.pdf", 
       plot = diff_abund_dna_char_plot_prevalence_median, width = 9, height = 5)
ggsave("figures/diff_abund_dna_char_plot_prevalence_median.jpg",
       plot = diff_abund_dna_char_plot_prevalence_median, width = 9, height = 5)

diff_abund_dna_char_plot_prevalence_median

ratio_abund_dna_char_plot =
  abund_dna_char %>% 
  ggplot(aes(x = dna_char_ratio, y = value.trend)) +
  geom_point(aes(color = dna_char, shape = sample_char)) +
  geom_smooth(method="lm", se=T) +
  scale_x_log10() +
  labs(x = "Ratio DNA concentration (mock/sample)", y = "Trend") +
  facet_grid(rows = vars(dna_char), cols = vars(sample_char))

ggsave("figures/ratio_abund_dna_char_plot.pdf", plot = ratio_abund_dna_char_plot, width = 9, height = 5)
ggsave("figures/ratio_abund_dna_char_plot.jpg", plot = ratio_abund_dna_char_plot, width = 9, height = 5)

ratio_abund_dna_char_plot

diff_abund_dna_char_plot =
  abund_dna_char %>% 
  ggplot(aes(x = dna_char_diff, y = value.trend)) +
  geom_point(aes(color = dna_char, shape = sample_char)) +
  geom_smooth(method="lm", se=T) +
  labs(x = "Difference DNA concentration (mock-sample) (ng/l)", y = "Trend") +
  facet_grid(rows = vars(dna_char), cols = vars(sample_char))

ggsave("figures/diff_abund_dna_char_plot.pdf", plot = diff_abund_dna_char_plot, width = 9, height = 5)
ggsave("figures/diff_abund_dna_char_plot.jpg", plot = diff_abund_dna_char_plot, width = 9, height = 5)

diff_abund_dna_char_plot

```

```{r statstiek contaminat slope}
# p value dna ratio
abund_dna_char_ratio =
abund_dna_char %>% 
  mutate(log_dna_char_ratio = log10(dna_char_ratio)) 

# test interactions between type of abundance measure and DNA concentration difference or ratio
abund_dna_char_ratio_2 =
  abund_dna_char_ratio %>% 
  filter(dna_char == "median_dnaconc") %>% 
  with(lm(value.trend ~ log_dna_char_ratio * sample_char))

anova(abund_dna_char_ratio_2)


# p value dna diff 
# overall linear regression test (Genus random variable)
abund_dna_char_diff =
  abund_dna_char %>% 
  filter(dna_char == "median_dnaconc") %>% 
  with(lm(value.trend ~ dna_char_diff * sample_char))

# anova
anova(abund_dna_char_diff)

#significant interaction 

# pairwise comparison of slopes among sample characters
emmeans::emtrends(abund_dna_char_diff, pairwise ~ sample_char, var = "dna_char_diff")
```
